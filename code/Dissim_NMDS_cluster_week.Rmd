---
title: "Dissim_NMDS_cluster"
author: "Jessica McCordic"
date: "2025-09-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Load libraries

```{r load lib}
library(tidyverse)
library(vegan)
library(dplyr)
library(tidyr)
library(ggplot2)
library(cluster)
library(RColorBrewer)
library(here)

```

## Vegan NMDS - Weekly comparisons by deployment

### Load in datasets
```{r load data}

# read in full distance matrix and metadata
dissim_og = read_csv("output/Weekly_dissim/dissim_matrix_dep_week_all.csv")

# load HMD weekly data -- has deployment ID and ISO week info
all_dep_metadata = read_csv("data/Df_analysis/All_deps_weekly_PSD.csv")

# get grouping info from original PSD data
all_dep_labels <- all_dep_metadata |>
  select(network, npz_id, Dep_ID, isoweek_UTC, effort_days) |>
  # use same filter for effort to only keep full weeks
  filter(effort_days == 7,
         # only keep MMP and SWC from Southwest network
         npz_id != "Jurien" & npz_id != "Geographe" & npz_id != "Two Rocks") |>
    # distinct combinations
  distinct() |>
  # create label that will match pivoted data to enable filtering
  mutate(dep = paste(Dep_ID, isoweek_UTC, sep = "_"))


weeks_to_use <- all_dep_labels |>
  group_by(network, isoweek_UTC) |>
  summarise(n_deps_wk = n()) |> 
  filter(n_deps_wk > 1)



dissim_all <- dissim_og |>
  left_join(all_dep_labels, by = "dep") |>
  filter(!is.na(Dep_ID))


```



### Filter to separate network matrices
```{r filter data}



dissim_te <- dissim_all |>
  select(dep, contains("CGMP") | contains("SIMP")) |>
  filter(grepl("CGMP", dep) | grepl("SIMP", dep)) |>
  left_join(all_dep_labels, by="dep") |>
  left_join(weeks_to_use) |>
  filter(!is.na(n_deps_wk)) 
dep_wk_te <- all_of(dissim_te$dep)
dissim_te <- dissim_te |>
  select(dep, dep_wk_te)


# get rid of deployment column to make square matrix
dissim_dist_te = as.dist(dissim_te |>
                        select(-dep))


dissim_nw <- dissim_all |>
  select(dep, contains("NINGALOO") | contains("DAMPIER")) |>
  filter(grepl("NINGALOO", dep) | grepl("DAMPIER", dep))

# get rid of deployment column to make square matrix
dissim_dist_nw = as.dist(dissim_nw |>
                        select(-dep))


dissim_sw <- dissim_all |>
  select(dep, contains("SWC") | contains("MURAT")) |>
  filter(grepl("SWC", dep) | grepl("MURAT", dep))

# get rid of deployment column to make square matrix
dissim_dist_sw = as.dist(dissim_sw |>
                        select(-dep))









# calculate nmds ordination from vegan package
nmds_te <- metaMDS(dissim_dist_te, k=2, trymax = 20, autotransform = FALSE, plot = FALSE)

# get nmds scores as data frame
nmdsScores_te <- as.data.frame(scores(nmds_te)) |>
  # add deployment-months (rownames) as separate column
  rownames_to_column(var = "dep") |>
  # join to label info
  left_join(all_dep_labels) |>
  mutate(week_fac = factor(isoweek_UTC))


# explore initial patterns in ordination
# network 
ggplot(aes(x = NMDS1, y = NMDS2, 
           color = Dep_ID,
           shape = npz_id), 
       data = nmdsScores_te)+ 
  theme_bw()+
  geom_point(size = 3)+
  geom_text(aes(label = week_fac), 
            vjust = -1, 
            hjust = 1.0)

# Month alone: nothing obvious 
ggplot(aes(x = NMDS1, y = NMDS2), data = nmdsScores)+ theme_bw()+
  geom_point(size = 3, aes(color = month_fac))

# NPZ, network, and month
ggplot(aes(x = NMDS1, y = NMDS2), data = nmdsScores)+ theme_bw()+
  geom_point(size = 3, aes(shape = network, color = npz_id))+
  geom_text(aes(label = month_fac), vjust = -1, hjust = 1.0)+
  theme(panel.grid.minor = element_blank(), 
        panel.grid.major = element_blank())+
  geom_hline(yintercept = 0, color = "grey")+
  geom_vline(xintercept = 0, color = "grey")

ggsave(paste0("figs/", "NMDS_month_labels_noJMPGMP.png"), width=12, height=8,
       units="in", dpi=300)



```