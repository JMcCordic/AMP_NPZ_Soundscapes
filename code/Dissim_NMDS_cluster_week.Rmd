---
title: "Dissim_NMDS_cluster"
author: "Jessica McCordic"
date: "2025-09-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Load libraries

```{r load lib}
library(tidyverse)
library(vegan)
library(dplyr)
library(tidyr)
library(ggplot2)
library(cluster)
library(RColorBrewer)
library(here)

```

## Vegan NMDS - Weekly comparisons by deployment

### Load in datasets
```{r load data}

# read in full distance matrix and metadata
dissim_og = read_csv("output/Weekly_dissim/dissim_matrix_dep_week_all.csv")

# load HMD weekly data -- has deployment ID and ISO week info
all_dep_metadata = read_csv("data/Df_analysis/All_deps_weekly_PSD.csv")

# get grouping info from original PSD data
all_dep_labels <- all_dep_metadata |>
  select(network, npz_id, Dep_ID, isoweek_UTC, effort_days) |>
  # use same filter for effort to only keep full weeks
  filter(effort_days == 7,
         # only keep MMP and SWC from Southwest network
         npz_id != "Jurien" & npz_id != "Geographe" & npz_id != "Two Rocks") |>
    # distinct combinations
  distinct() |>
  # create label that will match pivoted data to enable filtering
  mutate(dep = paste(Dep_ID, isoweek_UTC, sep = "_"))


weeks_to_use <- all_dep_labels |>
  group_by(network, isoweek_UTC) |>
  summarise(n_deps_wk = n()) |> 
  filter(n_deps_wk > 1)



dissim_all <- dissim_og |>
  left_join(all_dep_labels, by = "dep") |>
  filter(!is.na(Dep_ID))


```



### Filter to separate network matrices
```{r filter data}

#'---------------------------------------------------------------
#' Temperate East
#'---------------------------------------------------------------


dissim_te <- dissim_all |>
  select(dep, contains("CGMP") | contains("SIMP")) |>
  filter(grepl("CGMP", dep) | grepl("SIMP", dep)) |>
  # join to get week info by deployment
  left_join(all_dep_labels, by="dep") |>
  # join with subset of weeks common to multiple deployments
  left_join(weeks_to_use) |>
  # filter out remaining weeks
  filter(!is.na(n_deps_wk)) 
# get values of deployments left
dep_wk_te <- all_of(dissim_te$dep)
# select those columns to just get dissim values we care about
dissim_te <- dissim_te |>
  select(dep, all_of(dep_wk_te))


# get rid of deployment column to make square matrix, format as distance matrix
dissim_dist_te = as.dist(dissim_te |>
                        select(-dep))




#'---------------------------------------------------------------
#' North-west
#'---------------------------------------------------------------

dissim_nw <- dissim_all |>
  select(dep, contains("NINGALOO") | contains("DAMPIER")) |>
  filter(grepl("NINGALOO", dep) | grepl("DAMPIER", dep)) |>
  # join to get week info by deployment
  left_join(all_dep_labels, by="dep") |>
  # join with subset of weeks common to multiple deployments
  left_join(weeks_to_use) |>
  # filter out remaining weeks
  filter(!is.na(n_deps_wk)) 
# get values of deployments left
dep_wk_nw <- all_of(dissim_nw$dep)
# select those columns to just get dissim values we care about
dissim_nw <- dissim_nw |>
  select(dep, all_of(dep_wk_nw))


# get rid of deployment column to make square matrix, format as distance matrix
dissim_dist_nw = as.dist(dissim_nw |>
                        select(-dep))




#'---------------------------------------------------------------
#' South-west
#'---------------------------------------------------------------

dissim_sw <- dissim_all |>
  select(dep, contains("SWC") | contains("MURAT")) |>
  filter(grepl("SWC", dep) | grepl("MURAT", dep))|>
  # join to get week info by deployment
  left_join(all_dep_labels, by="dep") |>
  # join with subset of weeks common to multiple deployments
  left_join(weeks_to_use) |>
  # filter out remaining weeks
  filter(!is.na(n_deps_wk)) 
# get values of deployments left
dep_wk_sw <- all_of(dissim_sw$dep)
# select those columns to just get dissim values we care about
dissim_sw <- dissim_sw |>
  select(dep, all_of(dep_wk_sw))


# get rid of deployment column to make square matrix, format as distance matrix
dissim_dist_sw = as.dist(dissim_sw |>
                        select(-dep))
```




### NMDS by network

```{r NMDS}


#'-----------------------------------------------
#' Temperate East NMDS
#' ---------------------------------------------

# calculate nmds ordination from vegan package
nmds_te <- metaMDS(dissim_dist_te, k=2, trymax = 20, autotransform = FALSE, plot = FALSE)

# get nmds scores as data frame
nmdsScores_te <- as.data.frame(scores(nmds_te)) |>
  # add deployment-months (rownames) as separate column
  rownames_to_column(var = "dep") |>
  # join to label info
  left_join(all_dep_labels) |>
  mutate(week_fac = factor(isoweek_UTC))


# explore initial patterns in ordination
# network 
ggplot(aes(x = NMDS1, y = NMDS2, 
           color = Dep_ID,
           shape = npz_id), 
       data = nmdsScores_te)+ 
  theme_bw()+
  geom_point(size = 3)+
  geom_text(aes(label = week_fac), 
            vjust = -1, 
            hjust = 1.0)+
  labs(caption = "stress = 0.064")

# ggsave(paste0("figs/", "NMDS_week_tempeast.png"), width=12, height=8,
#        units="in", dpi=300)



#'-----------------------------------------------
#' North-west NMDS
#' ---------------------------------------------

# calculate nmds ordination from vegan package
nmds_nw <- metaMDS(dissim_dist_nw, k=2, trymax = 20, autotransform = FALSE, plot = TRUE)

# get nmds scores as data frame
nmdsScores_nw <- as.data.frame(scores(nmds_nw)) |>
  # add deployment-months (rownames) as separate column
  rownames_to_column(var = "dep") |>
  # join to label info
  left_join(all_dep_labels) |>
  mutate(week_fac = factor(isoweek_UTC))


# explore initial patterns in ordination
# network 
ggplot(aes(x = NMDS1, y = NMDS2, 
           color = Dep_ID,
           shape = npz_id), 
       data = nmdsScores_nw)+ 
  theme_bw()+
  geom_point(size = 3)+
  geom_text(aes(label = week_fac), 
            vjust = -1, 
            hjust = 1.0) +
  labs(caption = "stress = 0.217 (may have insufficient data)")

# ggsave(paste0("figs/", "NMDS_week_northwest.png"), width=12, height=8,
#        units="in", dpi=300)



#'-----------------------------------------------
#' South-west NMDS
#' ---------------------------------------------

# calculate nmds ordination from vegan package
nmds_sw <- metaMDS(dissim_dist_sw, k=2, trymax = 20, autotransform = FALSE, plot = FALSE)

# get nmds scores as data frame
nmdsScores_sw <- as.data.frame(scores(nmds_sw)) |>
  # add deployment-months (rownames) as separate column
  rownames_to_column(var = "dep") |>
  # join to label info
  left_join(all_dep_labels) |>
  mutate(week_fac = factor(isoweek_UTC))


# explore initial patterns in ordination
# network 
ggplot(aes(x = NMDS1, y = NMDS2, 
           color = Dep_ID,
           shape = npz_id), 
       data = nmdsScores_sw)+ 
  theme_bw()+
  geom_point(size = 3)+
  geom_text(aes(label = week_fac), 
            vjust = -1, 
            hjust = 1.0) +
  labs(caption = "stress = 0.0024")

# ggsave(paste0("figs/", "NMDS_week_southwest.png"), width=12, height=8,
#        units="in", dpi=300)


```