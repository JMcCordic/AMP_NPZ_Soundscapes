---
title: "Explore_HMD_plots"
output: html_document
date: "2025-07-18"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load lib}
library(PAMscapes)
library(PAMmisc)
library(tcltk2) # handles interactively navigating to network file paths
library(tidyverse)
library(tictoc) # allows for time tracking of longer processes
library(svDialogs) # allows for some interactive inputs
library(suntools) # tools for working with sunrise/sunset etc.
library(suncalc) # more options for sun things
```


Merge hourly HMD data from all deployments

```{r merge datasets}

dir_hmd <- tk_choose.dir(caption = "Select folder with hourly HMD files (.csv)")
  hmd_tables <- dir_hmd |>
    # list all files with .csv extension
    list.files(pattern = ".csv") |>
    map_chr(~paste0(dir_hmd,"\\",  .)) |>
    # use map to iterate read.delim() function over each file in the directory
    map(~read_csv(.))

all_hmd_og <- do.call("rbind", hmd_tables) 
```


```{r add columns}
all_hmd_data <- all_hmd_og |>
  mutate(
    # create NPZ column to simplify plot labels
    npz_id = str_replace(platform, "Parks Australia Cod Grounds Marine Park", "Cod Grounds"),
    npz_id = str_replace(npz_id, "Parks Australia Solitary Islands Marine Park, West Pimpernel mooring", "Solitary Islands"),
    npz_id = str_replace(npz_id, "Parks Australia Dampier Marine Park", "Dampier"),
    npz_id = str_replace(npz_id, "Parks Australia Ningaloo Marine Park, North mooring", "Ninglaoo"),
    npz_id = str_replace(npz_id, "Parks Australia Jurien Marine Park, Northeast mooring", "Jurien"),
    npz_id = str_replace(npz_id, "Parks Australia Geographe Marine Park", "Geographe"),
    npz_id = str_replace(npz_id, "Parks Australia Two Rocks Marine Park, West mooring", "Two Rocks"),
    npz_id = str_replace(npz_id, "Parks Australia South-west Corner Marine Park, South mooring", "South-west Corner"),
    npz_id = str_replace(npz_id, "Parks Australia Murat Marine Park, East mooring", "Murat"),
    
    # add network for grouping/faceting later
    network = case_when(platform == "Parks Australia Cod Grounds Marine Park" | 
                          platform == "Parks Australia Solitary Islands Marine Park, West Pimpernel mooring" 
                        ~ "Temperate East",
                        platform == "Parks Australia Dampier Marine Park" | 
                          platform == "Parks Australia Ningaloo Marine Park, North mooring" ~ "Northwest",
                        TRUE ~ "South-west"
    ),
    network = fct(network),
    network = fct_relevel(network, c("Temperate East","Northwest")),
    
    # parse out time info for plotting
    Begin_Hour_UTC = hour(UTC),
    Month_UTC = month(UTC)
    
  )
```


```{r Soundscape explorer}

runSoundscapeExplorer(all_hmd_data)

```

``` {r generate TOL data}

all_tol_data <- all_hmd_data |>
  group_by(Dep_ID) |>
  createOctaveLevel(type = "tol")


# get hourly quantiles for plotting
TOL10khz_hour <- all_tol_data |>
  # remove rows with NA values
  filter(is.na(TOL_13) == FALSE) |>
  # group by Dep_ID and hour, retain other grouping vars
  group_by(network, npz_id, Dep_ID, Latitude, Longitude, Begin_Hour_UTC) |>
  # calculate q10, q50, q90
  summarise(
    q10_tol = quantile(TOL_10000, 0.1),
    med_tol = quantile(TOL_10000, 0.5),
    q90_tol = quantile(TOL_10000, 0.9)
  )


# get hourly quantiles for plotting
TOL10khz_month_hour <- all_tol_data |>
  # remove rows with NA values
  filter(is.na(TOL_13) == FALSE) |>
  # group by Dep_ID and hour, retain other grouping vars
  group_by(network, npz_id, Dep_ID, Latitude, Longitude, Month_UTC, Begin_Hour_UTC) |>
  # calculate q10, q50, q90
  summarise(
    q10_tol = quantile(TOL_10000, 0.1),
    med_tol = quantile(TOL_10000, 0.5),
    q90_tol = quantile(TOL_10000, 0.9)
  )


```

### Plots to try out


```{r diel line plots}

# Adapting code from Bella for diel plots

ggplot(data = TOL10khz_hour,
       aes(x = Begin_Hour_UTC,
           fill = npz_id,
           color = npz_id)) +
  geom_ribbon(aes(ymin = q10_tol, 
                  ymax = q90_tol,
                  group = Dep_ID),
              alpha = 0.2) +
  geom_line(aes(y = med_tol,
                group = Dep_ID)) + 
  # facet_grid(rows = vars(network))+
  theme_bw()



ggplot(data = TOL10khz_month_hour,
       aes(x = Begin_Hour_UTC,
           fill = npz_id,
           color = npz_id)) +
  geom_ribbon(aes(ymin = q10_tol, 
                  ymax = q90_tol,
                  group = as.factor(Month_UTC)),
              alpha = 0.2) +
  geom_line(aes(y = med_tol,
                group = Dep_ID)) + 
  facet_grid(rows = vars(Month_UTC))+
  theme_bw()



```



```{r PSD plots}
# each NPZ, deployment PSDs
plotPSD(all_hmd_data, 
        style="quantile", 
        by="Dep_ID", 
        facet="npz_id", 
        q=0.1)

ggsave(paste0("figs/", "PSD_all_npz_facet_dep.png"), width=12, height=8,
       units="in", dpi=300)


# Network PSDs
plotPSD(all_hmd_data, 
        style="quantile", 
        by="npz_id", 
        facet="network",
        q=0.1)

ggsave(paste0("figs/", "PSD_all_npz_facet_network.png"), width=12, height=8,
       units="in", dpi=300)


# All NPZs together, full PSD
# bit of spaghetti soup but kind of interesting
plotPSD(all_hmd_data, style="quantile", by="npz_id", q=0.1)

ggsave(paste0("figs/", "PSD_all_npz.png"), width=12, height=8,
       units="in", dpi=300)



# hourly PSD by NPZ
plotPSD(all_hmd_data, style="quantile", by="hour", facet="npz_id", q=0.1)




# Monthly PSD across all NPZs
plotPSD(all_hmd_data, style="quantile", by="month", q=0.1)

# Monthly PSDs, faceted by NPZ
plotPSD(all_hmd_data, style="quantile", by="month", facet="npz_id", q=0.1)

ggsave(paste0("figs/", "PSD_month_facet_npz.png"), width=12, height=8,
       units="in", dpi=300)

# Monthly PSDs, faceted by network
plotPSD(all_hmd_data, style="quantile", by="month", facet="network", q=0.1)

ggsave(paste0("figs/", "PSD_month_facet_network.png"), width=12, height=8,
       units="in", dpi=300)


```



